<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>äº§å“è¯¦æƒ… - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .product-detail-container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    .product-detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 48px;
      margin-bottom: 32px;
    }
    .product-image-large {
      width: 100%;
      height: 400px;
      object-fit: cover;
      border-radius: 12px;
      background: #f5f5f5;
      cursor: pointer;
    }
    .product-detail-info h1 {
      font-size: 28px;
      margin-bottom: 16px;
    }
    .product-detail-price {
      font-size: 36px;
      font-weight: 700;
      color: #ff6700;
      margin-bottom: 16px;
    }
    .product-detail-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    .product-detail-meta .meta-item {
      font-size: 14px;
      color: #666;
    }
    .product-detail-description {
      margin-bottom: 24px;
      line-height: 1.8;
      color: #666;
    }
    .quantity-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    .quantity-selector label {
      font-weight: 500;
      color: #333;
    }
    .action-buttons {
      display: flex;
      gap: 12px;
    }
    @media (max-width: 768px) {
      .product-detail-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <div style="margin-bottom: 16px;">
        <a href="products.html" style="color: #666; font-size: 14px;">â† è¿”å›äº§å“åˆ—è¡¨</a>
      </div>

      <div class="product-detail-container" id="productDetail">
        <div class="text-center" style="padding: 48px;">
          <div class="loading"></div>
          <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatPrice, showSuccess, showError, getUrlParam } from '../assets/js/utils.js';
    import { showImageModal } from '../assets/js/modal.js';

    initNavigation();

    const productId = getUrlParam('id');
    let currentProduct = null;

    if (!productId) {
      location.href = 'products.html';
    }

    // åŠ è½½äº§å“è¯¦æƒ…
    async function loadProductDetail() {
      try {
        const product = await api.get(`/products/${productId}`);
        currentProduct = product;
        
        // è®°å½•æµè§ˆå†å²
        try {
          await api.post(`/history/add`, { product_id: productId });
        } catch (e) {
          console.log('è®°å½•æµè§ˆå†å²å¤±è´¥:', e);
        }

        displayProduct(product);
      } catch (error) {
        console.error('åŠ è½½äº§å“è¯¦æƒ…å¤±è´¥:', error);
        document.getElementById('productDetail').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <p class="empty-text">äº§å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶</p>
            <a href="products.html" class="btn btn-primary mt-md">è¿”å›äº§å“åˆ—è¡¨</a>
          </div>
        `;
      }
    }

    // æ˜¾ç¤ºäº§å“ä¿¡æ¯
    function displayProduct(product) {
      document.getElementById('productDetail').innerHTML = `
        <div class="product-detail-grid">
          <div>
            <img 
              src="${product.image_url || 'https://via.placeholder.com/400x400?text=' + encodeURIComponent(product.product_name)}" 
              alt="${product.product_name}"
              class="product-image-large"
              onclick="previewImage(this.src)"
              onerror="this.src='https://via.placeholder.com/400x400?text=å›¾ç‰‡åŠ è½½å¤±è´¥'"
            />
          </div>

          <div class="product-detail-info">
            <h1>${product.product_name}</h1>
            
            <div class="product-detail-price">${formatPrice(product.price)}</div>

            <div class="product-detail-meta">
              <div class="meta-item">
                <strong>åº“å­˜ï¼š</strong> ${product.stock_quantity} ä»¶
              </div>
              ${product.category_name ? `
                <div class="meta-item">
                  <strong>åˆ†ç±»ï¼š</strong> ${product.category_name}
                </div>
              ` : ''}
              ${product.is_featured ? `
                <div class="badge badge-primary">ç²¾é€‰å•†å“</div>
              ` : ''}
            </div>

            <div class="product-detail-description">
              <h3>äº§å“æè¿°</h3>
              <p>${product.description || 'æš‚æ— è¯¦ç»†æè¿°'}</p>
            </div>

            <div class="quantity-selector">
              <label>æ•°é‡ï¼š</label>
              <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
              <input 
                type="number" 
                id="quantity" 
                class="quantity-input" 
                value="1" 
                min="1" 
                max="${product.stock_quantity}"
              />
              <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
            </div>

            <div class="action-buttons">
              <button 
                class="btn btn-primary btn-lg" 
                style="flex: 1;"
                onclick="addToCart()"
                ${product.stock_quantity === 0 ? 'disabled' : ''}
              >
                ${product.stock_quantity === 0 ? 'å·²å”®ç½„' : 'ğŸ›’ åŠ å…¥è´­ç‰©è½¦'}
              </button>
              <button 
                class="btn btn-success btn-lg" 
                style="flex: 1;"
                onclick="buyNow()"
                ${product.stock_quantity === 0 ? 'disabled' : ''}
              >
                ${product.stock_quantity === 0 ? 'å·²å”®ç½„' : 'âš¡ ç«‹å³è´­ä¹°'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ä¿®æ”¹æ•°é‡
    window.changeQuantity = function(delta) {
      const input = document.getElementById('quantity');
      let value = parseInt(input.value) + delta;
      value = Math.max(1, Math.min(value, currentProduct.stock_quantity));
      input.value = value;
    };

    // å›¾ç‰‡é¢„è§ˆ
    window.previewImage = function(src) {
      showImageModal(src, currentProduct.product_name);
    };

    // åŠ å…¥è´­ç‰©è½¦
    window.addToCart = async function() {
      const quantity = parseInt(document.getElementById('quantity').value);
      
      try {
        await api.post('/cart/add', {
          product_id: productId,
          quantity: quantity
        });
        showSuccess(`å·²æ·»åŠ  ${quantity} ä»¶åˆ°è´­ç‰©è½¦`);
      } catch (error) {
        showError(error.message || 'æ·»åŠ è´­ç‰©è½¦å¤±è´¥');
      }
    };

    // ç«‹å³è´­ä¹°
    window.buyNow = async function() {
      const quantity = parseInt(document.getElementById('quantity').value);
      
      try {
        // å…ˆæ·»åŠ åˆ°è´­ç‰©è½¦
        await api.post('/cart/add', {
          product_id: productId,
          quantity: quantity
        });
        
        // è·³è½¬åˆ°è´­ç‰©è½¦
        location.href = 'cart.html';
      } catch (error) {
        showError(error.message || 'æ“ä½œå¤±è´¥');
      }
    };

    // é¡µé¢åŠ è½½
    loadProductDetail();
  </script>
</body>
</html>