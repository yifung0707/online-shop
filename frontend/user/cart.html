<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>è´­ç‰©è½¦ - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .cart-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }
    .cart-summary {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 24px;
      height: fit-content;
      position: sticky;
      top: 80px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 15px;
      color: #666;
    }
    .summary-total {
      display: flex;
      justify-content: space-between;
      padding-top: 16px;
      margin-top: 16px;
      border-top: 2px solid rgba(0, 0, 0, 0.1);
      font-size: 20px;
      font-weight: 700;
      color: #ff6700;
    }
    .cart-item-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 12px;
    }
    @media (max-width: 968px) {
      .cart-container {
        grid-template-columns: 1fr;
      }
      .cart-summary {
        position: static;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <div class="flex-between mb-lg">
        <h1>ğŸ›’ è´­ç‰©è½¦</h1>
        <button class="btn btn-secondary" onclick="clearCart()">æ¸…ç©ºè´­ç‰©è½¦</button>
      </div>

      <div class="cart-container">
        <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨ -->
        <div id="cartItems">
          <div class="text-center" style="padding: 48px;">
            <div class="loading"></div>
            <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
          </div>
        </div>

        <!-- ç»“ç®—æ‘˜è¦ -->
        <div class="cart-summary">
          <h3 style="margin-bottom: 16px;">è®¢å•æ‘˜è¦</h3>
          <div class="summary-row">
            <span>å•†å“æ•°é‡ï¼š</span>
            <span id="totalItems">0</span>
          </div>
          <div class="summary-row">
            <span>å•†å“æ€»é¢ï¼š</span>
            <span id="subtotal">Â¥0.00</span>
          </div>
          <div class="summary-total">
            <span>åˆè®¡ï¼š</span>
            <span id="total">Â¥0.00</span>
          </div>
          <button 
            class="btn btn-primary btn-block btn-lg mt-lg" 
            id="checkoutBtn"
            onclick="checkout()"
            disabled
          >
            å»ç»“ç®—
          </button>
          <a href="products.html" class="btn btn-ghost btn-block mt-md">ç»§ç»­è´­ç‰©</a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatPrice, showSuccess, showError } from '../assets/js/utils.js';
    import { showConfirm } from '../assets/js/modal.js';

    initNavigation();

    let cartData = [];

    // åŠ è½½è´­ç‰©è½¦
    async function loadCart() {
      try {
        const data = await api.get('/cart');
        cartData = data.items;
        displayCart(data);
      } catch (error) {
        console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:', error);
        showError('åŠ è½½è´­ç‰©è½¦å¤±è´¥');
      }
    }

    // æ˜¾ç¤ºè´­ç‰©è½¦
    function displayCart(data) {
      const container = document.getElementById('cartItems');
      const checkoutBtn = document.getElementById('checkoutBtn');

      if (data.items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ›’</div>
            <p class="empty-text">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
            <a href="products.html" class="btn btn-primary mt-md">å»è´­ç‰©</a>
          </div>
        `;
        checkoutBtn.disabled = true;
        updateSummary(0, 0);
        return;
      }

      container.innerHTML = data.items.map(item => `
        <div class="cart-item">
          <img 
            src="${item.image_url || 'https://via.placeholder.com/100x100'}" 
            alt="${item.product_name}"
            class="cart-item-image"
            onerror="this.src='https://via.placeholder.com/100x100?text=å›¾ç‰‡'"
          />
          <div class="cart-item-info">
            <div class="cart-item-name">${item.product_name}</div>
            <div class="cart-item-price">${formatPrice(item.price)}</div>
            <div style="font-size: 13px; color: #999; margin-top: 4px;">
              åº“å­˜: ${item.stock_quantity}
            </div>
            <div class="cart-item-actions">
              <div class="cart-item-quantity">
                <button class="quantity-btn" onclick="updateQuantity(${item.cart_id}, ${item.quantity - 1})">-</button>
                <input 
                  type="number" 
                  class="quantity-input" 
                  value="${item.quantity}" 
                  min="1"
                  max="${item.stock_quantity}"
                  onchange="updateQuantity(${item.cart_id}, this.value)"
                />
                <button class="quantity-btn" onclick="updateQuantity(${item.cart_id}, ${item.quantity + 1})">+</button>
              </div>
              <button class="btn btn-danger btn-sm" onclick="removeItem(${item.cart_id})">åˆ é™¤</button>
            </div>
            <div style="margin-top: 8px; font-size: 14px; color: #666;">
              å°è®¡: <strong style="color: #ff6700;">${formatPrice(item.subtotal)}</strong>
            </div>
          </div>
        </div>
      `).join('');

      checkoutBtn.disabled = false;
      updateSummary(data.items.length, data.total);
    }

    // æ›´æ–°æ‘˜è¦
    function updateSummary(itemCount, total) {
      document.getElementById('totalItems').textContent = itemCount + ' ä»¶';
      document.getElementById('subtotal').textContent = formatPrice(total);
      document.getElementById('total').textContent = formatPrice(total);
    }

    // æ›´æ–°æ•°é‡
    window.updateQuantity = async function(cartId, newQuantity) {
      newQuantity = parseInt(newQuantity);
      if (newQuantity < 1) return;

      try {
        await api.put(`/cart/${cartId}`, { quantity: newQuantity });
        showSuccess('å·²æ›´æ–°');
        loadCart();
      } catch (error) {
        showError(error.message || 'æ›´æ–°å¤±è´¥');
      }
    };

    // åˆ é™¤å•†å“
    window.removeItem = async function(cartId) {
      const confirmed = await showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ', 'åˆ é™¤ç¡®è®¤');
      if (!confirmed) return;

      try {
        await api.delete(`/cart/${cartId}`);
        showSuccess('å·²åˆ é™¤');
        loadCart();
      } catch (error) {
        showError(error.message || 'åˆ é™¤å¤±è´¥');
      }
    };

    // æ¸…ç©ºè´­ç‰©è½¦
    window.clearCart = async function() {
      if (cartData.length === 0) {
        showError('è´­ç‰©è½¦å·²ç»æ˜¯ç©ºçš„äº†');
        return;
      }

      const confirmed = await showConfirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ', 'æ¸…ç©ºç¡®è®¤');
      if (!confirmed) return;

      try {
        await api.delete('/cart');
        showSuccess('è´­ç‰©è½¦å·²æ¸…ç©º');
        loadCart();
      } catch (error) {
        showError(error.message || 'æ¸…ç©ºå¤±è´¥');
      }
    };

    // å»ç»“ç®—
    window.checkout = async function() {
      if (cartData.length === 0) {
        showError('è´­ç‰©è½¦æ˜¯ç©ºçš„');
        return;
      }

      // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ï¼ˆå…ˆåˆ›å»ºè®¢å•ï¼‰
      try {
        const result = await api.post('/orders/create', {
          shipping_address: 'å¾…å¡«å†™' // å®é™…åº”è¯¥è®©ç”¨æˆ·é€‰æ‹©åœ°å€
        });
        
        showSuccess('è®¢å•åˆ›å»ºæˆåŠŸ');
        // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
        setTimeout(() => {
          location.href = `payment.html?order_id=${result.order_id}`;
        }, 1000);
      } catch (error) {
        showError(error.message || 'åˆ›å»ºè®¢å•å¤±è´¥');
      }
    };

    // é¡µé¢åŠ è½½
    loadCart();
  </script>
</body>
</html>