<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æ”¯ä»˜è®¢å• - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .payment-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .payment-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(255, 103, 0, 0.2);
    }
    .payment-methods {
      display: grid;
      gap: 12px;
    }
    .payment-method {
      display: flex;
      align-items: center;
      padding: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .payment-method:hover {
      border-color: #ff6700;
    }
    .payment-method.selected {
      border-color: #ff6700;
      background: rgba(255, 103, 0, 0.05);
    }
    .payment-method input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .payment-method-icon {
      font-size: 32px;
      margin-right: 12px;
    }
    .payment-method-info {
      flex: 1;
    }
    .payment-method-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .payment-method-desc {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    .order-summary-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .order-summary-item:last-child {
      border-bottom: none;
    }
    .payment-total {
      display: flex;
      justify-content: space-between;
      font-size: 24px;
      font-weight: 700;
      color: #ff6700;
      padding-top: 16px;
      margin-top: 16px;
      border-top: 2px solid rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <div class="payment-container">
        <h1 style="text-align: center; margin-bottom: 32px;">ğŸ’³ æ”¯ä»˜è®¢å•</h1>

        <!-- è®¢å•ä¿¡æ¯ -->
        <div class="payment-section">
          <div class="section-title">ğŸ“‹ è®¢å•ä¿¡æ¯</div>
          <div id="orderInfo">
            <div class="text-center" style="padding: 24px;">
              <div class="loading"></div>
              <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>

        <!-- æ”¯ä»˜æ–¹å¼ -->
        <div class="payment-section">
          <div class="section-title">ğŸ’³ é€‰æ‹©æ”¯ä»˜æ–¹å¼</div>
          <div class="payment-methods">
            <label class="payment-method selected" onclick="selectPaymentMethod('alipay')">
              <input type="radio" name="payment_method" value="alipay" checked />
              <div class="payment-method-icon">ğŸ’°</div>
              <div class="payment-method-info">
                <div class="payment-method-name">æ”¯ä»˜å®</div>
                <div class="payment-method-desc">ä½¿ç”¨æ”¯ä»˜å®è´¦æˆ·æ”¯ä»˜</div>
              </div>
            </label>

            <label class="payment-method" onclick="selectPaymentMethod('wechat')">
              <input type="radio" name="payment_method" value="wechat" />
              <div class="payment-method-icon">ğŸ’š</div>
              <div class="payment-method-info">
                <div class="payment-method-name">å¾®ä¿¡æ”¯ä»˜</div>
                <div class="payment-method-desc">ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜</div>
              </div>
            </label>

            <label class="payment-method" onclick="selectPaymentMethod('credit_card')">
              <input type="radio" name="payment_method" value="credit_card" />
              <div class="payment-method-icon">ğŸ’³</div>
              <div class="payment-method-info">
                <div class="payment-method-name">ä¿¡ç”¨å¡</div>
                <div class="payment-method-desc">æ”¯æŒ Visaã€MasterCardã€é“¶è”</div>
              </div>
            </label>
          </div>
        </div>

        <!-- æ”¯ä»˜æŒ‰é’® -->
        <div class="payment-section">
          <button 
            class="btn btn-primary btn-block btn-lg" 
            id="payBtn"
            onclick="processPayment()"
            disabled
          >
            ç¡®è®¤æ”¯ä»˜
          </button>
          <button 
            class="btn btn-ghost btn-block mt-md" 
            onclick="location.href='orders.html'"
          >
            è¿”å›è®¢å•åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatPrice, showSuccess, showError, getUrlParam, showLoading, hideLoading } from '../assets/js/utils.js';

    initNavigation();

    const orderId = getUrlParam('order_id');
    let selectedPaymentMethod = 'alipay';
    let orderData = null;

    if (!orderId) {
      showError('è®¢å•IDä¸å­˜åœ¨');
      setTimeout(() => location.href = 'orders.html', 2000);
    }

    // é€‰æ‹©æ”¯ä»˜æ–¹å¼
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
    };

    // åŠ è½½è®¢å•ä¿¡æ¯
    async function loadOrderInfo() {
      try {
        const order = await api.get(`/orders/${orderId}`);
        orderData = order;

        if (order.status !== 'unpaid') {
          showError('è¯¥è®¢å•å·²æ”¯ä»˜æˆ–å·²å–æ¶ˆ');
          setTimeout(() => location.href = 'orders.html', 2000);
          return;
        }

        displayOrder(order);
        document.getElementById('payBtn').disabled = false;
      } catch (error) {
        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
        document.getElementById('orderInfo').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <p class="empty-text">è®¢å•ä¸å­˜åœ¨</p>
            <a href="orders.html" class="btn btn-primary mt-md">è¿”å›è®¢å•åˆ—è¡¨</a>
          </div>
        `;
      }
    }

    // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
    function displayOrder(order) {
      const container = document.getElementById('orderInfo');
      
      container.innerHTML = `
        <div class="order-summary-item">
          <span style="color: #666;">è®¢å•å·ï¼š</span>
          <span style="font-weight: 600;">#${order.order_id}</span>
        </div>
        <div class="order-summary-item">
          <span style="color: #666;">ä¸‹å•æ—¶é—´ï¼š</span>
          <span>${new Date(order.created_at).toLocaleString('zh-CN')}</span>
        </div>
        <div class="order-summary-item">
          <span style="color: #666;">é…é€åœ°å€ï¼š</span>
          <span>${order.shipping_address || 'å¾…å¡«å†™'}</span>
        </div>
        ${order.items ? `
          <div style="margin-top: 16px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #333;">å•†å“æ¸…å•ï¼š</div>
            ${order.items.map(item => `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; color: #666;">
                <span>${item.product_name} Ã— ${item.quantity}</span>
                <span>${formatPrice(item.price * item.quantity)}</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
        <div class="payment-total">
          <span>åº”ä»˜é‡‘é¢ï¼š</span>
          <span>${formatPrice(order.total_amount)}</span>
        </div>
      `;
    }

    // å¤„ç†æ”¯ä»˜
    window.processPayment = async function() {
      if (!orderData) {
        showError('è®¢å•ä¿¡æ¯ä¸å­˜åœ¨');
        return;
      }

      const payBtn = document.getElementById('payBtn');
      payBtn.disabled = true;
      payBtn.textContent = 'å¤„ç†ä¸­...';

      showLoading('æ­£åœ¨å¤„ç†æ”¯ä»˜...');

      try {
        // è°ƒç”¨æ”¯ä»˜æ¥å£
        const result = await api.post('/payment/create', {
          order_id: orderId,
          payment_method: selectedPaymentMethod
        });

        hideLoading();
        showSuccess('æ”¯ä»˜æˆåŠŸï¼');

        // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸåè·³è½¬
        setTimeout(() => {
          location.href = `orders.html`;
        }, 2000);

      } catch (error) {
        hideLoading();
        showError(error.message || 'æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        payBtn.disabled = false;
        payBtn.textContent = 'ç¡®è®¤æ”¯ä»˜';
      }
    };

    // é¡µé¢åŠ è½½
    loadOrderInfo();
  </script>
</body>
</html>