<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æˆ‘çš„è®¢å• - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .order-filters {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    .filter-btn:hover {
      border-color: #ff6700;
      color: #ff6700;
    }
    .filter-btn.active {
      background: #ff6700;
      color: #fff;
      border-color: #ff6700;
    }
    .order-actions-inline {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <h1>ğŸ“¦ æˆ‘çš„è®¢å•</h1>

      <!-- è®¢å•çŠ¶æ€ç­›é€‰ -->
      <div class="order-filters">
        <button class="filter-btn active" data-status="" onclick="filterOrders('')">
          å…¨éƒ¨è®¢å•
        </button>
        <button class="filter-btn" data-status="unpaid" onclick="filterOrders('unpaid')">
          å¾…æ”¯ä»˜
        </button>
        <button class="filter-btn" data-status="paid" onclick="filterOrders('paid')">
          å·²æ”¯ä»˜
        </button>
        <button class="filter-btn" data-status="shipped" onclick="filterOrders('shipped')">
          å·²å‘è´§
        </button>
        <button class="filter-btn" data-status="delivered" onclick="filterOrders('delivered')">
          å·²å®Œæˆ
        </button>
        <button class="filter-btn" data-status="cancelled" onclick="filterOrders('cancelled')">
          å·²å–æ¶ˆ
        </button>
      </div>

      <!-- è®¢å•åˆ—è¡¨ -->
      <div id="ordersList">
        <div class="text-center" style="padding: 48px;">
          <div class="loading"></div>
          <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatPrice, formatDate, showSuccess, showError, getOrderStatusText } from '../assets/js/utils.js';
    import { showConfirm } from '../assets/js/modal.js';

    initNavigation();

    let allOrders = [];
    let currentFilter = '';

    // åŠ è½½è®¢å•
    async function loadOrders() {
      try {
        const orders = await api.get('/orders');
        allOrders = orders;
        displayOrders(orders);
      } catch (error) {
        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
        showError('åŠ è½½è®¢å•å¤±è´¥');
      }
    }

    // æ˜¾ç¤ºè®¢å•
    function displayOrders(orders) {
      const container = document.getElementById('ordersList');

      if (orders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“¦</div>
            <p class="empty-text">è¿˜æ²¡æœ‰è®¢å•</p>
            <a href="products.html" class="btn btn-primary mt-md">å»è´­ç‰©</a>
          </div>
        `;
        return;
      }

      container.innerHTML = orders.map(order => `
        <div class="order-card">
          <div class="order-header">
            <div>
              <div class="order-id">è®¢å•å·: #${order.order_id}</div>
              <div style="font-size: 13px; color: #999; margin-top: 4px;">
                ${formatDate(order.created_at)}
              </div>
            </div>
            <div class="order-status ${order.status}">
              ${getOrderStatusText(order.status)}
            </div>
          </div>

          ${order.items && order.items.length > 0 ? `
            <div class="order-items">
              ${order.items.map(item => `
                <div class="order-item">
                  <img 
                    src="${item.image_url || 'https://via.placeholder.com/60x60'}" 
                    alt="${item.product_name}"
                    class="order-item-image"
                    onerror="this.src='https://via.placeholder.com/60x60?text=å›¾ç‰‡'"
                  />
                  <div class="order-item-info">
                    <div class="order-item-name">${item.product_name}</div>
                    <div class="order-item-quantity">æ•°é‡: ${item.quantity}</div>
                  </div>
                  <div class="order-item-price">${formatPrice(item.price)}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}

          <div class="order-total">
            <span>è®¢å•æ€»é¢</span>
            <span>${formatPrice(order.total_amount)}</span>
          </div>

          ${order.shipping_address ? `
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0, 0, 0, 0.05); font-size: 14px; color: #666;">
              <strong>é…é€åœ°å€ï¼š</strong>${order.shipping_address}
            </div>
          ` : ''}

          <div class="order-actions-inline">
            ${order.status === 'unpaid' ? `
              <button class="btn btn-primary btn-sm" onclick="payOrder(${order.order_id})">
                å»æ”¯ä»˜
              </button>
              <button class="btn btn-danger btn-sm" onclick="cancelOrder(${order.order_id})">
                å–æ¶ˆè®¢å•
              </button>
            ` : ''}
            ${order.status === 'delivered' ? `
              <button class="btn btn-success btn-sm" disabled>
                å·²å®Œæˆ
              </button>
            ` : ''}
            ${order.status === 'shipped' ? `
              <button class="btn btn-secondary btn-sm" disabled>
                é…é€ä¸­...
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    // ç­›é€‰è®¢å•
    window.filterOrders = function(status) {
      currentFilter = status;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.status === status);
      });

      // ç­›é€‰æ•°æ®
      const filtered = status 
        ? allOrders.filter(order => order.status === status)
        : allOrders;
      
      displayOrders(filtered);
    };

    // å»æ”¯ä»˜
    window.payOrder = function(orderId) {
      location.href = `payment.html?order_id=${orderId}`;
    };

    // å–æ¶ˆè®¢å•
    window.cancelOrder = async function(orderId) {
      const confirmed = await showConfirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ', 'å–æ¶ˆè®¢å•');
      if (!confirmed) return;

      try {
        await api.put(`/orders/${orderId}/cancel`);
        showSuccess('è®¢å•å·²å–æ¶ˆ');
        loadOrders();
      } catch (error) {
        showError(error.message || 'å–æ¶ˆè®¢å•å¤±è´¥');
      }
    };

    // é¡µé¢åŠ è½½
    loadOrders();
  </script>
</body>
</html> 