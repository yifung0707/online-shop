<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>äº§å“åˆ—è¡¨ - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .filters-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
    }
    .category-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .category-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    .category-btn:hover {
      border-color: #ff6700;
      color: #ff6700;
    }
    .category-btn.active {
      background: #ff6700;
      color: #fff;
      border-color: #ff6700;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <h1>ğŸ›ï¸ äº§å“åˆ—è¡¨</h1>
      
      <!-- æœç´¢å’Œç­›é€‰ -->
      <div class="filters-section">
        <div class="search-bar">
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="æœç´¢äº§å“åç§°..."
          />
          <button class="btn btn-primary" onclick="searchProducts()">æœç´¢</button>
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">äº§å“åˆ†ç±»ï¼š</label>
          <div class="category-filters" id="categoryFilters">
            <button class="category-btn active" data-category="">å…¨éƒ¨</button>
          </div>
        </div>
      </div>

      <!-- äº§å“åˆ—è¡¨ -->
      <div class="grid grid-4" id="productsList">
        <div class="text-center" style="grid-column: 1 / -1; padding: 48px;">
          <div class="loading"></div>
          <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatPrice, showError, debounce } from '../assets/js/utils.js';

    initNavigation();

    let allProducts = [];
    let currentCategory = '';
    let searchKeyword = '';

    // åŠ è½½åˆ†ç±»
    async function loadCategories() {
      try {
        const categories = await api.get('/products/categories/all');
        const container = document.getElementById('categoryFilters');
        
        categories.forEach(cat => {
          const btn = document.createElement('button');
          btn.className = 'category-btn';
          btn.textContent = cat.category_name;
          btn.dataset.category = cat.category_id;
          btn.onclick = () => filterByCategory(cat.category_id);
          container.appendChild(btn);
        });
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
      }
    }

    // åŠ è½½æ‰€æœ‰äº§å“
    async function loadProducts() {
      try {
        const products = await api.get('/products');
        allProducts = products;
        displayProducts(products);
      } catch (error) {
        console.error('åŠ è½½äº§å“å¤±è´¥:', error);
        showError('åŠ è½½äº§å“å¤±è´¥');
      }
    }

    // æ˜¾ç¤ºäº§å“
    function displayProducts(products) {
      const container = document.getElementById('productsList');
      
      if (products.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-icon">ğŸ“¦</div>
            <p class="empty-text">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³äº§å“</p>
          </div>
        `;
        return;
      }

      container.innerHTML = products.map(product => `
        <div class="product-card" onclick="location.href='product-detail.html?id=${product.product_id}'">
          <img 
            src="${product.image_url || 'https://via.placeholder.com/300x300?text=' + encodeURIComponent(product.product_name)}" 
            alt="${product.product_name}"
            class="product-image"
            onerror="this.src='https://via.placeholder.com/300x300?text=å›¾ç‰‡åŠ è½½å¤±è´¥'"
          />
          <div class="product-info">
            <div class="product-name">${product.product_name}</div>
            <div class="product-description">${product.description || 'æš‚æ— æè¿°'}</div>
            <div class="product-price">${formatPrice(product.price)}</div>
            <div class="product-stock">åº“å­˜: ${product.stock_quantity}</div>
            ${product.category_name ? `<div class="badge badge-secondary" style="margin-bottom: 12px;">${product.category_name}</div>` : ''}
            <div class="product-actions">
              <button class="btn btn-primary btn-sm btn-block">æŸ¥çœ‹è¯¦æƒ…</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // æŒ‰åˆ†ç±»ç­›é€‰
    window.filterByCategory = function(categoryId) {
      currentCategory = categoryId;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.category === categoryId);
      });

      // ç­›é€‰äº§å“
      filterProducts();
    };

    // æœç´¢äº§å“
    window.searchProducts = function() {
      searchKeyword = document.getElementById('searchInput').value.trim();
      filterProducts();
    };

    // ç»¼åˆç­›é€‰
    function filterProducts() {
      let filtered = allProducts;

      // åˆ†ç±»ç­›é€‰
      if (currentCategory) {
        filtered = filtered.filter(p => p.category_id == currentCategory);
      }

      // å…³é”®è¯æœç´¢
      if (searchKeyword) {
        filtered = filtered.filter(p => 
          p.product_name.toLowerCase().includes(searchKeyword.toLowerCase()) ||
          (p.description && p.description.toLowerCase().includes(searchKeyword.toLowerCase()))
        );
      }

      displayProducts(filtered);
    }

    // æœç´¢æ¡†å®æ—¶æœç´¢ï¼ˆé˜²æŠ–ï¼‰
    const debouncedSearch = debounce(() => {
      searchProducts();
    }, 500);

    document.getElementById('searchInput').addEventListener('input', debouncedSearch);
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchProducts();
    });

    // é¡µé¢åŠ è½½
    loadCategories();
    loadProducts();
  </script>
</body>
</html>