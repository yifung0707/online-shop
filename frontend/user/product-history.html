<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æµè§ˆå†å² - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <div class="flex-between mb-lg">
        <h1>ğŸ“‹ æµè§ˆå†å²</h1>
        <button class="btn btn-secondary" onclick="clearHistory()">
          æ¸…ç©ºå†å²
        </button>
      </div>

      <!-- æµè§ˆå†å²åˆ—è¡¨ -->
      <div class="grid grid-4" id="historyList">
        <div class="text-center" style="grid-column: 1 / -1; padding: 48px;">
          <div class="loading"></div>
          <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatPrice, formatRelativeTime, showSuccess, showError } from '../assets/js/utils.js';
    import { showConfirm } from '../assets/js/modal.js';

    initNavigation();

    // åŠ è½½æµè§ˆå†å²
    async function loadHistory() {
      try {
        const history = await api.get('/history?limit=50');
        displayHistory(history);
      } catch (error) {
        console.error('åŠ è½½æµè§ˆå†å²å¤±è´¥:', error);
        document.getElementById('historyList').innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-icon">âš ï¸</div>
            <p class="empty-text">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>
          </div>
        `;
      }
    }

    // æ˜¾ç¤ºæµè§ˆå†å²
    function displayHistory(history) {
      const container = document.getElementById('historyList');

      if (history.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-icon">ğŸ“‹</div>
            <p class="empty-text">è¿˜æ²¡æœ‰æµè§ˆè®°å½•</p>
            <a href="products.html" class="btn btn-primary mt-md">å»é€›é€›</a>
          </div>
        `;
        return;
      }

      container.innerHTML = history.map(item => `
        <div class="product-card" onclick="location.href='product-detail.html?id=${item.product_id}'">
          <img 
            src="${item.image_url || 'https://via.placeholder.com/300x300?text=' + encodeURIComponent(item.product_name)}" 
            alt="${item.product_name}"
            class="product-image"
            onerror="this.src='https://via.placeholder.com/300x300?text=å›¾ç‰‡åŠ è½½å¤±è´¥'"
          />
          <div class="product-info">
            <div class="product-name">${item.product_name}</div>
            <div class="product-description">${item.description || 'æš‚æ— æè¿°'}</div>
            <div class="product-price">${formatPrice(item.price)}</div>
            <div style="font-size: 12px; color: #999; margin-bottom: 12px;">
              ${formatRelativeTime(item.viewed_at)}
            </div>
            ${item.stock_quantity > 0 ? `
              <div class="product-actions">
                <button 
                  class="btn btn-primary btn-sm btn-block" 
                  onclick="event.stopPropagation(); viewProduct(${item.product_id})"
                >
                  å†çœ‹çœ‹
                </button>
              </div>
            ` : `
              <div class="badge badge-secondary" style="width: 100%; text-align: center;">
                å·²å”®ç½„
              </div>
            `}
          </div>
        </div>
      `).join('');
    }

    // æŸ¥çœ‹äº§å“
    window.viewProduct = function(productId) {
      location.href = `product-detail.html?id=${productId}`;
    };

    // æ¸…ç©ºæµè§ˆå†å²
    window.clearHistory = async function() {
      const confirmed = await showConfirm(
        'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµè§ˆå†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
        'æ¸…ç©ºç¡®è®¤'
      );
      
      if (!confirmed) return;

      try {
        await api.delete('/history/clear');
        showSuccess('æµè§ˆå†å²å·²æ¸…ç©º');
        loadHistory();
      } catch (error) {
        showError(error.message || 'æ¸…ç©ºå¤±è´¥');
      }
    };

    // é¡µé¢åŠ è½½
    loadHistory();
  </script>
</body>
</html>