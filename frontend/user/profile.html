<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ä¸ªäººä¸­å¿ƒ - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .profile-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .profile-header {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: 700;
      margin: 0 auto 16px;
    }
    .profile-sections {
      display: grid;
      gap: 24px;
    }
    .profile-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(255, 103, 0, 0.2);
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .info-item:last-child {
      border-bottom: none;
    }
    .info-label {
      color: #666;
      font-weight: 500;
    }
    .info-value {
      color: #333;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .stat-item {
      text-align: center;
      padding: 16px;
      background: rgba(255, 103, 0, 0.05);
      border-radius: 8px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #ff6700;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 13px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <div class="profile-container">
        <!-- ä¸ªäººä¿¡æ¯å¤´éƒ¨ -->
        <div class="profile-header">
          <div class="profile-avatar" id="userAvatar">U</div>
          <h2 id="userName">åŠ è½½ä¸­...</h2>
          <p style="color: #666; margin-top: 8px;" id="userEmail">-</p>
          <button class="btn btn-primary mt-md" onclick="editProfile()">
            ç¼–è¾‘èµ„æ–™
          </button>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-title">ğŸ“Š æˆ‘çš„ç»Ÿè®¡</div>
          </div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="totalOrders">0</div>
              <div class="stat-label">æ€»è®¢å•</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="totalSpent">Â¥0</div>
              <div class="stat-label">æ€»æ¶ˆè´¹</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="totalProducts">0</div>
              <div class="stat-label">æµè§ˆå•†å“</div>
            </div>
          </div>
        </div>

        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-title">ğŸ‘¤ åŸºæœ¬ä¿¡æ¯</div>
            <button class="btn btn-secondary btn-sm" onclick="editProfile()">ç¼–è¾‘</button>
          </div>
          <div id="basicInfo">
            <div class="info-item">
              <span class="info-label">ç”¨æˆ·åï¼š</span>
              <span class="info-value" id="infoUsername">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">é‚®ç®±ï¼š</span>
              <span class="info-value" id="infoEmail">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">å§“åï¼š</span>
              <span class="info-value" id="infoFullName">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">æ‰‹æœºå·ï¼š</span>
              <span class="info-value" id="infoPhone">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">æ³¨å†Œæ—¶é—´ï¼š</span>
              <span class="info-value" id="infoCreatedAt">-</span>
            </div>
          </div>
        </div>

        <!-- å¿«æ·æ“ä½œ -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-title">âš¡ å¿«æ·æ“ä½œ</div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <button class="btn btn-ghost" onclick="location.href='orders.html'">
              ğŸ“¦ æˆ‘çš„è®¢å•
            </button>
            <button class="btn btn-ghost" onclick="location.href='product-history.html'">
              ğŸ“‹ æµè§ˆå†å²
            </button>
            <button class="btn btn-ghost" onclick="location.href='cart.html'">
              ğŸ›’ è´­ç‰©è½¦
            </button>
            <button class="btn btn-ghost" onclick="changePassword()">
              ğŸ” ä¿®æ”¹å¯†ç 
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api, getUserInfo } from '../assets/js/api.js';
    import { formatDate, formatPrice, showSuccess, showError } from '../assets/js/utils.js';
    import { showFormModal, showPrompt } from '../assets/js/modal.js';

    initNavigation();

    let currentUserData = null;

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    async function loadUserProfile() {
      try {
        const userInfo = getUserInfo();
        currentUserData = userInfo.user;

        // æ›´æ–°å¤´éƒ¨
        document.getElementById('userAvatar').textContent = 
          (currentUserData.username || 'U')[0].toUpperCase();
        document.getElementById('userName').textContent = currentUserData.username || 'ç”¨æˆ·';
        document.getElementById('userEmail').textContent = currentUserData.email || '-';

        // æ›´æ–°åŸºæœ¬ä¿¡æ¯
        document.getElementById('infoUsername').textContent = currentUserData.username || '-';
        document.getElementById('infoEmail').textContent = currentUserData.email || '-';
        document.getElementById('infoFullName').textContent = currentUserData.full_name || 'æœªå¡«å†™';
        document.getElementById('infoPhone').textContent = currentUserData.phone || 'æœªå¡«å†™';
        document.getElementById('infoCreatedAt').textContent = 
          currentUserData.created_at ? formatDate(currentUserData.created_at) : '-';

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        loadStats();

      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        showError('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        // è·å–è®¢å•ç»Ÿè®¡
        const orders = await api.get('/orders');
        const completedOrders = orders.filter(o => o.status !== 'cancelled');
        const totalSpent = completedOrders.reduce((sum, o) => sum + parseFloat(o.total_amount), 0);

        document.getElementById('totalOrders').textContent = completedOrders.length;
        document.getElementById('totalSpent').textContent = formatPrice(totalSpent);

        // è·å–æµè§ˆå†å²ç»Ÿè®¡
        try {
          const history = await api.get('/history/stats');
          document.getElementById('totalProducts').textContent = 
            history.top_products?.length || 0;
        } catch (e) {
          console.log('åŠ è½½æµè§ˆç»Ÿè®¡å¤±è´¥:', e);
        }

      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    }

    // ç¼–è¾‘èµ„æ–™ï¼ˆä½¿ç”¨æ¨¡æ€æ¡†ï¼‰
    window.editProfile = function() {
      showFormModal({
        title: 'âœï¸ ç¼–è¾‘ä¸ªäººèµ„æ–™',
        fields: [
          { 
            name: 'full_name', 
            label: 'å§“å', 
            type: 'text',
            placeholder: 'è¯·è¾“å…¥çœŸå®å§“å',
            defaultValue: currentUserData.full_name || ''
          },
          { 
            name: 'phone', 
            label: 'æ‰‹æœºå·', 
            type: 'tel',
            placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·',
            defaultValue: currentUserData.phone || ''
          }
        ],
        submitText: 'ä¿å­˜',
        onSubmit: async (data) => {
          try {
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åç«¯æ”¯æŒæ›´æ–°ç”¨æˆ·ä¿¡æ¯çš„API
            // ç”±äºå½“å‰åç«¯æ²¡æœ‰è¿™ä¸ªæ¥å£ï¼Œè¿™é‡Œåªæ˜¯æ¼”ç¤º
            // await api.put('/user/profile', data);
            
            // ä¸´æ—¶æ›´æ–°æœ¬åœ°æ•°æ®
            currentUserData.full_name = data.full_name;
            currentUserData.phone = data.phone;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('infoFullName').textContent = data.full_name || 'æœªå¡«å†™';
            document.getElementById('infoPhone').textContent = data.phone || 'æœªå¡«å†™';
            
            showSuccess('èµ„æ–™å·²æ›´æ–°');
            return true;
          } catch (error) {
            showError(error.message || 'æ›´æ–°å¤±è´¥');
            return false;
          }
        }
      });
    };

    // ä¿®æ”¹å¯†ç 
    window.changePassword = async function() {
      const newPassword = await showPrompt(
        'è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰',
        '',
        'ğŸ” ä¿®æ”¹å¯†ç '
      );

      if (!newPassword) return;

      if (newPassword.length < 6) {
        showError('å¯†ç è‡³å°‘éœ€è¦6ä½');
        return;
      }

      try {
        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åç«¯æ”¯æŒä¿®æ”¹å¯†ç çš„API
        // await api.put('/user/password', { password: newPassword });
        showSuccess('å¯†ç å·²ä¿®æ”¹ï¼ˆæ¼”ç¤ºåŠŸèƒ½ï¼‰');
      } catch (error) {
        showError(error.message || 'ä¿®æ”¹å¤±è´¥');
      }
    };

    // é¡µé¢åŠ è½½
    loadUserProfile();
  </script>
</body>
</html>