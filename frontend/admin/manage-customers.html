<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>å®¢æˆ·ç®¡ç† - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .search-bar {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .search-input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <h1>ğŸ‘¥ å®¢æˆ·ç®¡ç†</h1>

      <!-- æœç´¢æ  -->
      <div class="search-bar">
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="æœç´¢å®¢æˆ·ç”¨æˆ·åæˆ–é‚®ç®±..."
        />
        <button class="btn btn-primary" onclick="searchCustomers()">æœç´¢</button>
      </div>

      <!-- å®¢æˆ·åˆ—è¡¨ -->
      <div class="data-table" id="customersTable">
        <div class="text-center" style="padding: 48px;">
          <div class="loading"></div>
          <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatDate, showError, debounce } from '../assets/js/utils.js';
    import { showContentModal } from '../assets/js/modal.js';

    initNavigation();

    let allCustomers = [];

    // åŠ è½½å®¢æˆ·åˆ—è¡¨
    async function loadCustomers() {
      try {
        const customers = await api.get('/admin/customers');
        allCustomers = customers;
        displayCustomers(customers);
      } catch (error) {
        console.error('åŠ è½½å®¢æˆ·å¤±è´¥:', error);
        showError('åŠ è½½å®¢æˆ·å¤±è´¥');
      }
    }

    // æ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨
    function displayCustomers(customers) {
      const container = document.getElementById('customersTable');

      if (customers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ‘¥</div>
            <p class="empty-text">æ²¡æœ‰æ‰¾åˆ°å®¢æˆ·</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ç”¨æˆ·å</th>
              <th>é‚®ç®±</th>
              <th>å§“å</th>
              <th>æ‰‹æœºå·</th>
              <th>æ³¨å†Œæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${customers.map(customer => `
              <tr>
                <td>${customer.user_id}</td>
                <td style="font-weight: 600;">${customer.username}</td>
                <td>${customer.email}</td>
                <td>${customer.full_name || '-'}</td>
                <td>${customer.phone || '-'}</td>
                <td style="font-size: 13px;">${formatDate(customer.created_at)}</td>
                <td>
                  <button class="btn btn-primary btn-sm" onclick="viewCustomerDetail(${customer.user_id})">
                    æŸ¥çœ‹è¯¦æƒ…
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // æœç´¢å®¢æˆ·
    window.searchCustomers = function() {
      const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
      
      if (!keyword) {
        displayCustomers(allCustomers);
        return;
      }

      const filtered = allCustomers.filter(customer => 
        customer.username.toLowerCase().includes(keyword) ||
        customer.email.toLowerCase().includes(keyword) ||
        (customer.full_name && customer.full_name.toLowerCase().includes(keyword))
      );

      displayCustomers(filtered);
    };

    // å®æ—¶æœç´¢
    const debouncedSearch = debounce(() => {
      searchCustomers();
    }, 500);

    document.getElementById('searchInput').addEventListener('input', debouncedSearch);
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchCustomers();
    });

    // æŸ¥çœ‹å®¢æˆ·è¯¦æƒ…
    window.viewCustomerDetail = async function(userId) {
      try {
        const customer = await api.get(`/admin/customers/${userId}`);
        
        const content = `
          <div style="line-height: 2;">
            <p><strong>ç”¨æˆ·åï¼š</strong>${customer.username}</p>
            <p><strong>é‚®ç®±ï¼š</strong>${customer.email}</p>
            <p><strong>å§“åï¼š</strong>${customer.full_name || 'æœªå¡«å†™'}</p>
            <p><strong>æ‰‹æœºå·ï¼š</strong>${customer.phone || 'æœªå¡«å†™'}</p>
            <p><strong>æ³¨å†Œæ—¶é—´ï¼š</strong>${formatDate(customer.created_at)}</p>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
            <h4 style="margin-bottom: 10px;">ç»Ÿè®¡ä¿¡æ¯</h4>
            <p><strong>è®¢å•æ•°ï¼š</strong>${customer.stats?.total_orders || 0} ä¸ª</p>
            <p><strong>æ€»æ¶ˆè´¹ï¼š</strong>Â¥${parseFloat(customer.stats?.total_spent || 0).toFixed(2)}</p>
          </div>
        `;

        showContentModal(content, `ğŸ‘¤ å®¢æˆ·è¯¦æƒ… - ${customer.username}`);

      } catch (error) {
        showError('åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥');
      }
    };

    // é¡µé¢åŠ è½½
    loadCustomers();
  </script>
</body>
</html>