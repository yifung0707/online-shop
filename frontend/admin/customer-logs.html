<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>å®¢æˆ·æ—¥å¿— - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .log-filters {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .log-filters label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .log-filters input,
    .log-filters select {
      width: 100%;
      margin: 0;
      padding: 8px 12px;
    }
    .action-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    .action-login { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
    .action-logout { background: rgba(158, 158, 158, 0.1); color: #9e9e9e; }
    .action-register { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
    .action-view_product { background: rgba(33, 150, 243, 0.1); color: #2196f3; }
    .action-add_to_cart { background: rgba(255, 152, 0, 0.1); color: #ff9800; }
    .action-purchase { background: rgba(255, 103, 0, 0.1); color: #ff6700; }
    .action-search { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <h1>ğŸ“ å®¢æˆ·æ—¥å¿—</h1>

      <!-- ç­›é€‰å™¨ -->
      <div class="log-filters">
        <div>
          <label>è¡Œä¸ºç±»å‹:</label>
          <select id="actionType">
            <option value="">å…¨éƒ¨</option>
            <option value="login">ç™»å½•</option>
            <option value="logout">ç™»å‡º</option>
            <option value="register">æ³¨å†Œ</option>
            <option value="view_product">æµè§ˆäº§å“</option>
            <option value="add_to_cart">åŠ å…¥è´­ç‰©è½¦</option>
            <option value="purchase">è´­ä¹°</option>
            <option value="search">æœç´¢</option>
          </select>
        </div>

        <div>
          <label>å¼€å§‹æ—¥æœŸ:</label>
          <input type="date" id="startDate" />
        </div>

        <div>
          <label>ç»“æŸæ—¥æœŸ:</label>
          <input type="date" id="endDate" />
        </div>

        <div style="display: flex; align-items: flex-end;">
          <button class="btn btn-primary btn-block" onclick="loadLogs()">
            æŸ¥è¯¢
          </button>
        </div>
      </div>

      <!-- æ—¥å¿—åˆ—è¡¨ -->
      <div class="data-table" id="logsTable">
        <div class="text-center" style="padding: 48px;">
          <div class="loading"></div>
          <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatDate, showError } from '../assets/js/utils.js';

    initNavigation();

    // ä¸è®¾ç½®é»˜è®¤æ—¥æœŸï¼Œæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
    // å¦‚æœéœ€è¦é»˜è®¤ç­›é€‰ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
    // const endDate = new Date();
    // const startDate = new Date();
    // startDate.setDate(startDate.getDate() - 30); // æœ€è¿‘30å¤©
    // document.getElementById('startDate').valueAsDate = startDate;
    // document.getElementById('endDate').valueAsDate = endDate;

    // è¡Œä¸ºç±»å‹ä¸­æ–‡æ˜ å°„
    const actionTypeMap = {
      'login': 'ç™»å½•',
      'logout': 'ç™»å‡º',
      'register': 'æ³¨å†Œ',
      'view_product': 'æµè§ˆäº§å“',
      'add_to_cart': 'åŠ å…¥è´­ç‰©è½¦',
      'purchase': 'è´­ä¹°',
      'search': 'æœç´¢'
    };

    // åŠ è½½æ—¥å¿—
    window.loadLogs = async function() {
      const actionType = document.getElementById('actionType').value;
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;

      console.log('ğŸ” å¼€å§‹åŠ è½½æ—¥å¿—ï¼Œç­›é€‰æ¡ä»¶:', { actionType, start, end });

      try {
        const params = new URLSearchParams();
        if (actionType) params.append('action_type', actionType);
        if (start) params.append('start_date', start);
        if (end) params.append('end_date', end);

        console.log('ğŸ“¡ è¯·æ±‚ URL:', `/admin/customer-logs?${params}`);

        const logs = await api.get(`/admin/customer-logs?${params}`);
        
        console.log('âœ… è·å–åˆ°æ—¥å¿—æ•°æ®:', logs.length, 'æ¡');
        console.log('ğŸ“‹ æ—¥å¿—æ•°æ®ç¤ºä¾‹:', logs[0]);

        displayLogs(logs);

      } catch (error) {
        console.error('âŒ åŠ è½½æ—¥å¿—å¤±è´¥:', error);
        showError('åŠ è½½æ—¥å¿—å¤±è´¥');
        
        const container = document.getElementById('logsTable');
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <p class="empty-text">åŠ è½½å¤±è´¥: ${error.message}</p>
            <button class="btn btn-primary mt-md" onclick="loadLogs()">é‡è¯•</button>
          </div>
        `;
      }
    };

    // æ˜¾ç¤ºæ—¥å¿—åˆ—è¡¨
    function displayLogs(logs) {
      const container = document.getElementById('logsTable');
      
      console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“æ—¥å¿—ï¼Œæ•°é‡:', logs.length);
      console.log('ğŸ¨ å®¹å™¨å…ƒç´ :', container);

      if (!logs || logs.length === 0) {
        console.log('âš ï¸ æ²¡æœ‰æ—¥å¿—æ•°æ®');
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“</div>
            <p class="empty-text">æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—</p>
          </div>
        `;
        return;
      }

      try {
        const tableHTML = `
          <table>
            <thead>
              <tr>
                <th>æ—¶é—´</th>
                <th>ç”¨æˆ·</th>
                <th>è¡Œä¸ºç±»å‹</th>
                <th>è¯¦æƒ…</th>
                <th>IPåœ°å€</th>
              </tr>
            </thead>
            <tbody>
              ${logs.map(log => {
                console.log('ğŸ“ å¤„ç†æ—¥å¿—:', log.log_id, log.action_type);
                return `
                  <tr>
                    <td style="font-size: 13px; white-space: nowrap;">${formatDate(log.created_at)}</td>
                    <td style="font-weight: 600;">${log.username || 'æœªçŸ¥ç”¨æˆ·'}</td>
                    <td>
                      <span class="action-badge action-${log.action_type}">
                        ${actionTypeMap[log.action_type] || log.action_type}
                      </span>
                    </td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      ${log.details || '-'}
                    </td>
                    <td style="font-size: 13px; color: #999;">${log.ip_address || '-'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <div style="text-align: center; margin-top: 16px; color: #999; font-size: 14px;">
            å…± ${logs.length} æ¡è®°å½•ï¼ˆæœ€å¤šæ˜¾ç¤º 500 æ¡ï¼‰
          </div>
        `;

        container.innerHTML = tableHTML;
        console.log('âœ… æ—¥å¿—è¡¨æ ¼å·²æ¸²æŸ“å®Œæˆ');

      } catch (error) {
        console.error('âŒ æ¸²æŸ“æ—¥å¿—æ—¶å‡ºé”™:', error);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <p class="empty-text">æ¸²æŸ“å¤±è´¥: ${error.message}</p>
          </div>
        `;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥è¯¢
    console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æŸ¥è¯¢æ—¥å¿—');
    loadLogs();
  </script>
</body>
</html>