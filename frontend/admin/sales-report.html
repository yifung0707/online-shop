<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>é”€å”®æŠ¥è¡¨ - OnlineShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <link rel="stylesheet" href="../assets/css/navigation.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <style>
    .report-filters {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .report-filters label {
      margin: 0;
      font-weight: 500;
    }
    .report-filters input,
    .report-filters select {
      margin: 0;
      padding: 8px 12px;
      min-width: 150px;
    }
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    .report-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }
    .section-title-small {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(255, 103, 0, 0.2);
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <h1>ğŸ“ˆ é”€å”®æŠ¥è¡¨</h1>

      <!-- ç­›é€‰å™¨ -->
      <div class="report-filters">
        <label>å¼€å§‹æ—¥æœŸ:</label>
        <input type="date" id="startDate" />
        
        <label>ç»“æŸæ—¥æœŸ:</label>
        <input type="date" id="endDate" />
        
        <label>åˆ†ç»„æ–¹å¼:</label>
        <select id="groupBy">
          <option value="day">æŒ‰å¤©</option>
          <option value="month">æŒ‰æœˆ</option>
          <option value="year">æŒ‰å¹´</option>
        </select>
        
        <button class="btn btn-primary" onclick="loadReport()">æŸ¥è¯¢</button>
      </div>

      <!-- æ€»è§ˆç»Ÿè®¡ -->
      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-value" id="totalSales">Â¥0</div>
          <div class="stat-label">æ€»é”€å”®é¢</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“¦</div>
          <div class="stat-value" id="totalOrders">0</div>
          <div class="stat-label">æ€»è®¢å•æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-value" id="avgOrderValue">Â¥0</div>
          <div class="stat-label">å¹³å‡è®¢å•é¢</div>
        </div>
      </div>

      <!-- é”€å”®è¶‹åŠ¿ -->
      <div class="report-section">
        <div class="section-title-small">ğŸ“Š é”€å”®è¶‹åŠ¿</div>
        <div id="salesTimeline">
          <div class="text-center" style="padding: 24px;">
            <div class="loading"></div>
            <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- çƒ­é”€äº§å“ -->
      <div class="report-section">
        <div class="section-title-small">ğŸ† çƒ­é”€äº§å“ TOP 10</div>
        <div class="data-table" id="topProducts">
          <div class="text-center" style="padding: 24px;">
            <div class="loading"></div>
            <p style="margin-top: 16px; color: #666;">åŠ è½½ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initNavigation } from '../assets/js/navigation.js';
    import { api } from '../assets/js/api.js';
    import { formatPrice, showError } from '../assets/js/utils.js';

    initNavigation();

    // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ€è¿‘30å¤©ï¼‰
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);

    document.getElementById('startDate').valueAsDate = startDate;
    document.getElementById('endDate').valueAsDate = endDate;

    // åŠ è½½æŠ¥è¡¨
    window.loadReport = async function() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const groupBy = document.getElementById('groupBy').value;

      try {
        const params = new URLSearchParams();
        if (start) params.append('start_date', start);
        if (end) params.append('end_date', end);
        params.append('group_by', groupBy);

        const report = await api.get(`/admin/sales-report?${params}`);
        
        // æ˜¾ç¤ºç»Ÿè®¡
        displayStats(report.total);
        displayTimeline(report.timeline);
        displayTopProducts(report.top_products);

      } catch (error) {
        console.error('åŠ è½½æŠ¥è¡¨å¤±è´¥:', error);
        showError('åŠ è½½æŠ¥è¡¨å¤±è´¥');
      }
    };

    // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
    function displayStats(stats) {
      const totalSales = parseFloat(stats.total_sales || 0);
      const totalOrders = parseInt(stats.total_orders || 0);
      const avgValue = totalOrders > 0 ? totalSales / totalOrders : 0;

      document.getElementById('totalSales').textContent = formatPrice(totalSales);
      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('avgOrderValue').textContent = formatPrice(avgValue);
    }

    // æ˜¾ç¤ºæ—¶é—´çº¿
    function displayTimeline(timeline) {
      const container = document.getElementById('salesTimeline');

      if (!timeline || timeline.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <p class="empty-text">æš‚æ— æ•°æ®</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>æ—¶é—´</th>
              <th>é”€å”®é¢</th>
              <th>è®¢å•æ•°</th>
            </tr>
          </thead>
          <tbody>
            ${timeline.map(item => `
              <tr>
                <td style="font-weight: 600;">${item.period}</td>
                <td style="color: #ff6700; font-weight: 600;">${formatPrice(item.sales)}</td>
                <td>${item.orders} å•</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // æ˜¾ç¤ºçƒ­é”€äº§å“
    function displayTopProducts(products) {
      const container = document.getElementById('topProducts');

      if (!products || products.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ†</div>
            <p class="empty-text">æš‚æ— æ•°æ®</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>æ’å</th>
              <th>äº§å“åç§°</th>
              <th>é”€å”®æ•°é‡</th>
              <th>é”€å”®é¢</th>
            </tr>
          </thead>
          <tbody>
            ${products.map((product, index) => `
              <tr>
                <td>
                  <span style="font-size: 20px; font-weight: 700;">
                    ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `#${index + 1}`}
                  </span>
                </td>
                <td style="font-weight: 600;">${product.product_name}</td>
                <td>${product.total_sold} ä»¶</td>
                <td style="color: #ff6700; font-weight: 600;">${formatPrice(product.total_revenue)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥è¯¢
    loadReport();
  </script>
</body>
</html>